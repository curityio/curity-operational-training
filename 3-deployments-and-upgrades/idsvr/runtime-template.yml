#
# The deployment for the clustered runtime workloads
#
name: idsvr-runtime
location : $REGION
resourceGroup: $RESOURCE_GROUP
type: Microsoft.App/containerApps
identity:
  type: UserAssigned
  userAssignedIdentities:
    $IDENTITY_ID:
      clientId: $IDENTITY_CLIENT_ID
      principalId: $IDENTITY_PRINCIPAL_ID
properties:
  managedEnvironmentId: $ENVIRONMENT_ID
  configuration:
    registries:
    - identity: $IDENTITY_ID
      server: $REGISTRY.azurecr.io
    ingress:
      external: true
      targetPort: 8443
      allowInsecure: false
      additionalPortMappings:
      - external: false
        targetPort: 6789
        exposedPort: 6789
      - external: false
        targetPort: 6790
        exposedPort: 6790
  template:
    containers:
    - name: idsvr-runtime-container
      image: $IDSVR_IMAGE
      resources:
        cpu: 2
        memory: 4Gi
      env:
      - name: SERVICE_NAME
        value: 'Runtime'
      - name: LICENSE_KEY
        value: $LICENSE_KEY
      - name: ADMIN_BASE_URL
        value: $ADMIN_BASE_URL
      - name: RUNTIME_BASE_URL
        value: $RUNTIME_BASE_URL
      - name: ADMIN_PASSWORD
        value: $ADMIN_PASSWORD
      - name: DB_CONNECTION
        value: $DB_CONNECTION
      - name: DB_USER
        value: $DB_USER
      - name: DB_PASSWORD
        value: $DB_PASSWORD
      - name: CONFIG_ENCRYPTION_KEY
        value: $CONFIG_ENCRYPTION_KEY
      - name: SYMMETRIC_KEY
        value: $SYMMETRIC_KEY
      - name: SIGNING_KEY
        value: $SIGNING_KEY
      
      # These are only deployed if you deploy configurations from the administrator courses
      - name: MIGRATION_CLIENT_SECRET
        value: $MIGRATION_CLIENT_SECRET
      - name: INTROSPECT_CLIENT_SECRET
        value: $INTROSPECT_CLIENT_SECRET
      - name: EMPLOYEE_IDP_CLIENT_ID
        value: $EMPLOYEE_IDP_CLIENT_ID
      - name: INTROSPECT_CLIENT_SECRET
        value: $INTROSPECT_CLIENT_SECRET
      - name: EMPLOYEE_IDP_OIDC_METADATA
        value: $EMPLOYEE_IDP_OIDC_METADATA
      - name: ADMIN_CLIENT_SYMMETRIC_KEY
        value: $ADMIN_CLIENT_SYMMETRIC_KEY
      - name: SSL_TRUST_STORE
        value: $SSL_TRUST_STORE
      - name: BACKEND_JOB_CLIENT_SECRET
        value: $BACKEND_JOB_CLIENT_SECRET
      - name: TOKEN_EXCHANGE_CLIENT_SECRET
        value: $TOKEN_EXCHANGE_CLIENT_SECRET

      volumeMounts:
      - volumeName: cluster-volume
        mountPath: /opt/idsvr/etc/init/cluster.xml
        subPath: cluster.xml
    volumes:
    - name: cluster-volume
      storageName: $STORAGE_MOUNT
      storageType: AzureFile
    scale:
      minReplicas: 2
      maxReplicas: 2
